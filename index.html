<!DOCTYPE html>
<!-- saved from url=(0073)file:///D:/Users/ushan/snapnudify/webapp/index.html?id=photos/file_84.jpg -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Mask Creator</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        #container {
            position: relative;
            width: 500px;
            height: 500px;
        }

        #img, #canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        canvas {
            border: 1px solid #000;
            cursor: crosshair;
        }
    </style>
</head>
<body>
    <h1>Image Mask Creator</h1>
    <div id="container">
        <img id="img" width="500" height="500" src="./Image Mask Creator_files/file_84.jpg">
        <canvas id="canvas" width="500" height="500"></canvas>
    </div>
    <label for="brushSize">Brush Size:</label>
    <input type="range" id="brushSize" min="1" max="50" value="10" step="1">
    <br>
    <label for="strength">Change Strength:</label>
    <input type="range" id="strength" min="3" max="10" value="5" step="1">
    <br>
    <label for="gender">Gender:</label>
    <select id="gender">
        <option value="female">Female</option>
        <option value="male">Male</option>
    </select>
    <br>
    <label for="size">Size:</label>
    <select id="size">
        <option value="large">Large</option>
        <option value="medium" selected="">Medium</option>
        <option value="small">Small</option>
    </select>
    <br>
    <label for="view">View:</label>
    <select id="view">
        <option value="front">Front</option>
        <option value="back">Back</option>
    </select>
    <br>
    <label for="parts">Parts:</label>
    <select id="parts">
        <option value="top">Top Only</option>
        <option value="bottom">Bottom Only</option>
        <option value="all" selected="">All</option>
    </select>
    <br>
    <label for="hair">Hair:</label>
    <select id="hair">
        <option value="yes">Yes</option>
        <option value="no">No</option>
    </select>
    <br>
    <button onclick="sendData()">Send Data</button>

    <script>
        let tg = window.Telegram.WebApp;

        document.addEventListener("DOMContentLoaded", function() {
            const urlParams = new URLSearchParams(window.location.search);
            const fileId = urlParams.get('id');

            if (fileId) {
                const imgUrl = `https://api.telegram.org/file/bot5871863876:AAF0TkJMfh0QmVDg9Jz8AVLb9EULdhIkeRY/${fileId}`;
                const img = document.getElementById('img');
                img.src = imgUrl;

                img.onload = function() {
                    // Ensure that the canvas size matches the image size
                    const canvas = document.getElementById('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                };
            }
        });

        const container = document.getElementById('container');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        ctx.imageSmoothingEnabled = true;
        let isDrawing = false;

        let brushSize = 10;
        let strength = 5;
        let gender = "female";
        let size = "medium";
        let view = "front";
        let parts = "all";
        let hair = "yes";

        function draw(e) {
            if (!isDrawing) return;

            ctx.lineWidth = brushSize;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#fff';

            const rect = canvas.getBoundingClientRect();
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function startDrawing(e) {
            isDrawing = true;
            draw(e);
        }

        function stopDrawing() {
            isDrawing = false;
            ctx.beginPath();
        }

        function createMask() {

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
                // Set non-white pixels to black
                if (data[i] !== 255 || data[i + 1] !== 255 || data[i + 2] !== 255) {
                    data[i] = 0;
                    data[i + 1] = 0;
                    data[i + 2] = 0;
                    data[i + 3] = 255; // Set alpha to fully opaque
                }
            }

            // Create a temporary canvas to convert ImageData to base64
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            tempCtx.putImageData(imageData, 0, 0);

            // Convert the temporary canvas to base64
            const base64Data = tempCanvas.toDataURL('image/png');

            return base64Data;
        }

        function sendData() {

            const origImageSrc = document.getElementById('img').src;
            const maskImageData = createMask();

            const postData = {
                user_id: tg.initDataUnsafe.user.id,
                orig_image: origImageSrc,
                mask_image: maskImageData,
                cfg: strength,
                gender: gender,
                size: size,
                view: view,
                parts: parts,
                hair: hair
            };

            fetch('http://91.210.166.190:800/webapp', {
                mode: 'no-cors',
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(postData),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }

        document.getElementById('brushSize').addEventListener('input', function() {
            brushSize = this.value;
        });

        document.getElementById('strength').addEventListener('input', function() {
            strength = this.value;
        });

        document.getElementById('gender').addEventListener('change', function() {
            gender = this.value;
        });

        document.getElementById('size').addEventListener('change', function() {
            size = this.value;
        });

        document.getElementById('view').addEventListener('change', function() {
            view = this.value;
        });

        document.getElementById('parts').addEventListener('change', function() {
            parts = this.value;
        });

        document.getElementById('hair').addEventListener('change', function() {
            hair = this.value;
        });

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
    </script>


</body></html>
